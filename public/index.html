<!DOCTYPE html>

<html class="h-full" lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="htmlTitle">Play UP</title>

<!-- Socket.IO Client f√ºr Live Updates -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    tailwind.config = { darkMode: 'class' };
  </script>
<style>
    :root {
      --accent: #4B0082;
      --bg-light: radial-gradient(1200px 600px at 10% -10%, #f5f5f7, #fff) fixed;
      --bg-dark: radial-gradient(1200px 600px at 10% -10%, #111113, #000) fixed;
      --hairline: rgba(0,0,0,.08);
      --hairline-dark: rgba(255,255,255,.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      margin: 0;
      color: #1d1d1f;
      background: var(--bg-light);
    }
    body.dark {
      color: #f5f5f7;
      background: var(--bg-dark);
    }

    .hairline { border: 1px solid var(--hairline); }
    body.dark .hairline { border-color: var(--hairline-dark); }

    .surface {
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      border-radius: 1.25rem;
      border: 1px solid rgba(0,0,0,.06);
    }
    body.dark .surface {
      background: rgba(20,20,22,.7);
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }

    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    .tabs-container {
      position: relative;
      display: flex;
      gap: .25rem;
      align-items: center;
      padding: .25rem;
      border-radius: 9999px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.04);
    }
    body.dark .tabs-container {
      background: rgba(255,255,255,.06);
      border-color: var(--hairline-dark);
    }
    .tab-button {
      position: relative;
      z-index: 10;
      border: 0;
      background: transparent;
      cursor: pointer;
      padding: .375rem .875rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: .9rem;
      color: inherit;
      transition: color .2s ease;
    }
    .tab-button.active { color: #000; }
    body.dark .tab-button.active { color: #111; }
    .tab-button:hover { color: var(--accent); }

    .tabs-slider {
      position: absolute;
      top: 4px;
      height: calc(100% - 8px);
      width: var(--tab-width, 0px);
      left: var(--tab-left, 0px);
      border-radius: 9999px;
      background: var(--accent);
      transition: left .25s ease, width .25s ease, background-color .25s ease;
      z-index: 5;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      border-radius: 9999px;
      overflow: hidden;
      background: rgba(0,0,0,.06);
      min-width: 140px;
      justify-content: center;
    }
    body.dark .quantity-control { background: rgba(255,255,255,.08); }
    .quantity-control button {
      border: 0;
      background: transparent;
      padding: .35rem .6rem;
      font-size: 1.1rem;
      line-height: 1;
      cursor: pointer;
      color: inherit;
    }
    .quantity-control button:hover { background: rgba(0,0,0,.06); }
    body.dark .quantity-control button:hover { background: rgba(255,255,255,.12); }
    .quantity-control input {
      width: 3rem;
      text-align: center;
      border: 0;
      background: transparent;
      padding: .35rem .25rem;
      color: inherit;
      outline: none;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: .5rem;
      z-index: 50;
    }
    .dropdown-content.show {
      display: block;
    }


    #headerImage {
      opacity:0;
      transform:scale(.9) translateY(6px);
      transition: all .5s ease;
    }
    #headerImage.loaded {
      opacity:1;
      transform:scale(1) translateY(0);
    }


    #receiptPopup {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      background: white;
      color: black;
      font-family: monospace;
      font-size: .8rem;
      line-height:1.2;
      border: 1px solid #000;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      border-radius: .5rem;
      padding: 1rem;
      min-width: 200px;
      max-width: 240px;
      max-height: 0;
      overflow: hidden;
      z-index:1500;
      display:none;
    }
    body.dark #receiptPopup {
      background: #1e1e1e;
      color: #fff;
      border-color:#fff;
    }
    #receiptPopup.showing {
      animation: roll 0.4s ease forwards;
      display:block;
    }
    @keyframes roll {
      from { max-height: 0; }
      to   { max-height: 300px; }
    }

    /* Version badge bottom-right */
    #versionBadge {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      z-index: 1200;
      background: rgba(0,0,0,.7);
      color:#fff;
      font-size:.7rem;
      line-height:1.2;
      padding:.5rem .75rem;
      border-radius:.75rem;
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      cursor:pointer;
    }
    body.dark #versionBadge {
      background: rgba(255,255,255,.15);
      color:#fff;
    }


    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    .modal-card {
      background: rgba(255,255,255,.95);
      color:#1d1d1f;
      border-radius:1rem;
      padding:1.5rem;
      width:min(620px,92vw);
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      border:1px solid rgba(0,0,0,.06);
      position:relative;
    }
    body.dark .modal-card {
      background: rgba(28,28,30,.95);
      color:#f5f5f7;
      border-color:rgba(255,255,255,.12);
    }

    .scroll-area {
      max-height:200px;
      overflow:auto;
      font-size:.8rem;
      line-height:1.3;
      white-space:pre-wrap;
    }

    .hidden { display:none; }


    
.theme-select {
  appearance: none;
  background: rgba(0,0,0,.06);
  border-radius: 9999px;
  border: 1px solid var(--hairline);
  font-size: .7rem;
  font-weight: 600;
  padding: .4rem .75rem;
  line-height:1;
  color: #000;
}
body.dark .theme-select {
  background: #2a2a2a;
  border-color: rgba(255,255,255,.2);
  color: #fff;
}
.theme-select option {
  background: #fff;
  color: #000;
}
body.dark .theme-select option {
  background: #1e1e1e;
  color: #f5f5f5;
}

  
#statsModal .modal-card {
  max-height: 90vh;
  overflow-y: auto;
}


/* === Animations f√ºr Header === */
#headerImage {
  opacity: 0;
  transform: scale(1.4) translateY(-40px);
  animation: zoomInElastic 2s ease-out forwards;
}

@keyframes zoomInElastic {
  0% {
    opacity: 0;
    transform: scale(1.4) translateY(-40px);
  }
  60% {
    opacity: 1;
    transform: scale(0.95) translateY(10px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

#calculatorTitle {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeUp 1.5s ease forwards;
  animation-delay: 0.6s;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}


/* === Button-Klick Animation === */
.quantity-control button {
  transition: transform 0.1s ease, background-color 0.2s ease;
}

.quantity-control button:active {
  transform: scale(0.85);
  background-color: var(--accent);
  color: white;
}

/* Allgemeiner Hover-Effekt */
.quantity-control button:hover {
  transform: scale(1.1);
}

/* Kleine Pop-Animation beim Wertwechsel */
@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.15); }
  100% { transform: scale(1); }
}

.quantity-control input.updated {
  animation: pulse 0.25s ease;
}


/* === Microanimation: Button Shake === */
@keyframes wiggle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(2deg); }
  75% { transform: rotate(-2deg); }
}

button:active {
  animation: wiggle 0.25s ease;
}

/* === Sanftes Scrollen === */
html {
  scroll-behavior: smooth;
}

/* Live Update Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes flashHighlight {
  0%, 100% { background-color: transparent; }
  50% { background-color: rgba(75, 0, 130, 0.2); }
}

@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInUp {
  from { transform: translateY(100px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeOut {
  to { opacity: 0; transform: translateY(-20px); }
}

@keyframes pointsFloat {
  0% { opacity: 1; transform: translateY(0) scale(1); }
  100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes chartUpdate {
  0% { opacity: 0.5; transform: scale(0.98); }
  100% { opacity: 1; transform: scale(1); }
}

/* Utility Classes */
.fade-in { animation: fadeIn 0.3s ease-out forwards; }
.flash-highlight { animation: flashHighlight 2s ease-out; }
.pulse-animation { animation: pulse 1s ease-in-out 3; }

/* Notification Toast */
.notification-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 9999;
  animation: slideInRight 0.3s ease-out;
  max-width: 400px;
}

body.dark .notification-toast {
  background: #2d2d2f;
  color: #f5f5f7;
}

.notification-toast .icon {
  font-size: 1.5em;
  flex-shrink: 0;
}

.notification-toast .message {
  flex: 1;
  font-size: 0.95em;
}

.notification-toast .close-btn {
  background: none;
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  opacity: 0.6;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.notification-toast .close-btn:hover {
  opacity: 1;
}

.notification-toast.success { border-left: 4px solid #10b981; }
.notification-toast.warning { border-left: 4px solid #f59e0b; }
.notification-toast.error { border-left: 4px solid #ef4444; }
.notification-toast.info { border-left: 4px solid #3b82f6; }

/* Level Badges */
.level-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 600;
  display: inline-block;
  white-space: nowrap;
}

.points-badge {
  padding: 4px 12px;
  border-radius: 8px;
  font-size: 0.9em;
  font-weight: 600;
  display: inline-block;
}

.level-bronze,
.points-badge.level-bronze {
  background: linear-gradient(135deg, #CD7F32, #8B4513);
  color: white;
}

.level-silver,
.points-badge.level-silver {
  background: linear-gradient(135deg, #C0C0C0, #808080);
  color: white;
}

.level-gold,
.points-badge.level-gold {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #1d1d1f;
}

.level-platinum,
.points-badge.level-platinum {
  background: linear-gradient(135deg, #E5E4E2, #8B8B8B);
  color: white;
}

/* Points Animation */
.points-animation {
  position: fixed;
  font-size: 1.5em;
  font-weight: bold;
  color: #4B0082;
  pointer-events: none;
  z-index: 9999;
}

.points-animation.animate {
  animation: pointsFloat 2s ease-out forwards;
}

/* Level Up Modal */
.level-up-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
}

.level-up-content {
  background: white;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: scaleIn 0.5s ease-out;
  max-width: 400px;
}

body.dark .level-up-content {
  background: #1d1d1f;
}

.level-up-content h2 {
  font-size: 2.5em;
  margin-bottom: 20px;
  color: #4B0082;
}

body.dark .level-up-content h2 {
  color: #8B00FF;
}

.level-up-content .new-level {
  font-size: 2em;
  margin: 20px 0;
  padding: 20px;
  border-radius: 15px;
}

.level-up-content .confetti {
  font-size: 4em;
  margin-bottom: 20px;
  animation: bounce 1s infinite;
}

.level-up-content .close-btn {
  background: linear-gradient(135deg, #4B0082, #8B00FF);
  color: white;
  border: none;
  padding: 12px 32px;
  border-radius: 25px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
  margin-top: 20px;
}

.level-up-content .close-btn:hover {
  transform: scale(1.05);
}

/* Connection Status Indicator */
.connection-status {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: white;
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85em;
  z-index: 9998;
  transition: opacity 0.3s;
}

body.dark .connection-status {
  background: #2d2d2f;
}

.connection-status.hidden {
  opacity: 0;
  pointer-events: none;
}

.connection-status .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #10b981;
  animation: pulse 2s ease-in-out infinite;
}

.connection-status.disconnected .dot {
  background: #ef4444;
  animation: none;
}

.connection-status.connecting .dot {
  background: #f59e0b;
}

/* Rank Badge */
.rank-badge {
  display: inline-block;
  min-width: 28px;
  height: 28px;
  line-height: 28px;
  text-align: center;
  border-radius: 50%;
  background: rgba(75, 0, 130, 0.1);
  font-weight: bold;
  font-size: 0.9em;
  margin-right: 8px;
}

.rank-badge.rank-top {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: white;
}

/* Top Customer Indicator */
.top-customer {
  position: relative;
}

.top-customer::before {
  content: '‚≠ê';
  position: absolute;
  left: -20px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.2em;
}

/* Chart Update Animation */
.chart-updating {
  animation: chartUpdate 0.5s ease-out;
}

/* Stats List Entry Animation */
.stats-entry {
  transition: all 0.3s ease;
}

.stats-entry.new-entry {
  background: rgba(75, 0, 130, 0.1);
  animation: fadeIn 0.5s ease-out;
}

.stats-entry.removed-entry {
  animation: fadeOut 0.5s ease-out forwards;
}

/* Responsive adjustments */
@media (max-width: 640px) {
  .notification-toast {
    right: 10px;
    left: 10px;
    max-width: none;
  }
  
  .connection-status {
    left: 10px;
    bottom: 10px;
  }
  
  .level-up-content {
    margin: 20px;
    padding: 30px 20px;
  }
}

</style>
</head>
<body class="min-h-full dark:bg-black dark:text-gray-100">
<div id="receiptPopup"></div>
<div class="modal-backdrop" id="welcomeModal" style="display:flex;">
<div class="modal-card text-center">
<h2 class="text-2xl font-bold mb-3 text-[color:var(--accent)]">üëã Willkommen bei Play UP!</h2>
<p class="text-sm mb-4 opacity-80">Check immer mal wieder den Changelog! Einfach unten Rechts den Button Klicken. Meist kommen direkt n√ºtzliche und Interessante Sachen! Viel Spa√ü beim Verkauf! Lutalo#1</p>
<button class="bg-[color:var(--accent)] text-white px-4 py-2 rounded-full font-semibold" onclick="closeWelcome()">Los geht's üöÄ</button>
</div>
</div>
<div id="versionBadge">
<div>v1.6.0</div>
<div>Stand: 29.10.2025 üîî</div>
</div>
<div class="modal-backdrop" id="statsModal">
<div class="modal-card">
<button class="absolute top-2 right-2 px-2 py-1 rounded-md bg-black/10 text-xs dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20" onclick="closeStats()">X</button>
<h3 class="text-xl font-bold mb-4 flex items-center gap-2">üìà Umsatzverlauf</h3>
<canvas class="w-full h-40 mb-4" id="statsChart"></canvas>
<h3 class="text-lg font-bold mb-2 flex items-center gap-2">üè∑Ô∏è Umsatz pro Produkt</h3>
<canvas class="w-full h-40 mb-4" id="productStatsChart"></canvas>
<button class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg text-sm mb-4" onclick="resetProductStats()">üîÅ Produktstatistik l√∂schen</button>
<div class="relative mb-4">
<button class="w-full bg-[color:var(--accent)] text-white font-semibold py-2 px-4 rounded-lg text-sm flex justify-between items-center" onclick="toggleTopProductsDropdown()">
          üèÜ Top Produkte <span>‚ñæ</span>
</button>
<div class="dropdown-content surface p-3 w-full mt-2 text-sm" id="topProductsDropdown">
<div id="topProductsList">Noch keine Verk√§ufe.</div>
</div>
</div>
<div class="scroll-area hairline rounded-md p-2 bg-black/5 dark:bg-white/10 mb-4 text-sm" id="statsList"></div>
<div class="relative mb-4">
<button class="w-full bg-[color:var(--accent)] text-white font-semibold py-2 px-4 rounded-lg text-sm flex justify-between items-center" onclick="toggleRushHourDropdown()">
    üö¶ Rush-Hour Analyse <span>‚ñæ</span>
</button>
<div class="dropdown-content surface p-3 w-full mt-2 text-sm" id="rushHourDropdown">
<canvas class="w-full h-32" id="rushHourDropdownChart"></canvas>
</div>
</div>
<button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm" onclick="resetStats()">Verlauf l√∂schen</button>
</div>
</div>
<!-- Changelog Modal -->
<div class="modal-backdrop" id="changelogModal">
<div class="modal-card">
<button class="absolute top-2 right-2 px-2 py-1 rounded-md bg-black/10 text-xs dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20" onclick="closeChangelog()">X</button>
<h3 class="text-xl font-bold mb-2">Lutalo machts m√∂glich! 1.6.0 </h3>
<ul class="text-sm space-y-2 leading-5">
<br/>
<h3>üìù Changelog</h3>
<ul>
<li>üìç NEUER CHANGELOG VOM 29.10.25 üìç</li>
<li>üî¥ LIVE-UPDATES f√ºr Umsatzverlauf aktiviert</li>
<li>üî¥ LIVE-UPDATES f√ºr Produktstatistik aktiviert</li>
<li>üî¥ LIVE-UPDATES f√ºr L√∂schfunktionen aktiviert</li>
<li>üìä Echtzeit-Synchronisation aller Clients</li>
<li>‚ú® Animierte Chart-Updates bei neuen Verk√§ufen</li>
<li>üé® Verbesserte Visualisierung bei Daten√§nderungen</li>
<br/>
<br/>
<li>üìç LETZTER CHANGELOG VOM 28.10.25 WAR: üìç</li>
<li>üé®White/Darkmode Toggel Funktioniert</li>
<li>üé®Neue Animationen</li>
<li>üìä Rush Hour Analyse im Umsatzverlauf</li>
<li>üñ•Ô∏è UI Fix</li>
<br/>
<br/>
<li>üìç LETZTER CHANGELOG VOM 27.10.25 WAR: üìç</li>
<li>üì¶ Kategorien getrennt: "STICKER" und "FIGUREN"</li>
<li>üßæ Separate Rendering und Berechnung</li>
<li>üìä Statistik & Auswertung gefixt</li>
</ul>
</ul>
<div class="text-[10px] text-right mt-4 opacity-60 select-none">29.10.25 1.6.0</div>
</div>
</div>
<div class="px-4 sm:px-6 lg:px-8 py-6">
<div class="surface w-full max-w-6xl mx-auto p-6 sm:p-8 relative" id="mainSurface" style="opacity:1;">
<div class="absolute top-4 right-4 flex flex-col items-end gap-2 text-sm z-10">
<div class="flex items-center gap-2 text-xs">
<label class="text-[10px] font-semibold opacity-70">Theme:</label>
<select class="theme-select" id="themeSelect"></select>
</div>

<div class="flex items-center gap-2 text-sm">
<span aria-hidden="">üåû</span>
<label class="relative inline-flex items-center cursor-pointer select-none dark-toggle">
<input class="sr-only peer" id="themeToggle" type="checkbox"/>
<div class="w-12 h-6 rounded-full hairline bg-black/10 dark:bg-white/20 transition relative">
<span class="absolute top-[3px] left-[3px] h-5 w-5 rounded-full bg-white dark:bg-zinc-200 shadow transition-transform duration-300 ease-in-out peer-checked:translate-x-6"></span>
</div>
</label>
<span aria-hidden="">üåô</span>
<button class="px-3 py-1.5 rounded-full hairline bg-black/5 dark:bg-white/10 font-semibold text-xs whitespace-nowrap flex items-center gap-1" onclick="openStats()">
    üìà Umsatzverlauf
  </button>
</div>
<style>
/* Fallback CSS, falls Tailwind peer-check nicht greift */
.dark-toggle input:checked + div span {
  transform: translateX(1.5rem);
  transition: transform 0.3s ease-in-out;
}
</style>

</div>
<div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-6 mb-6">
<div class="flex-1 min-w-0 flex justify-start relative">
<button class="px-4 py-2 rounded-full hairline bg-black/5 dark:bg-white/10 font-semibold flex items-center gap-2" onclick="toggleDropdown()">
            Unternehmen <span aria-hidden="">‚ñæ</span>
</button>
<div class="dropdown-content surface p-4 w-80" id="unternehmenDropdown">
<h5 class="font-bold mb-2">Unternehmen</h5>
<div class="grid grid-cols-2 gap-2 text-sm">
<div class="rounded-xl hairline p-2">
<label class="inline-flex items-center gap-2">
<input checked="" class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value=""/>
<span class="font-semibold">Kein Unternehmen</span>
</label>
</div>
<div class="rounded-xl hairline p-2">
<h6 class="font-medium text-xs mb-1 opacity-70">10/10</h6>
<label class="inline-flex items-center gap-2">
<input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Tuner"/>
<span>Tuner</span>
</label>
</div>
<div class="rounded-xl hairline p-2">
<h6 class="font-medium text-xs mb-1 opacity-70">50/50</h6>
<div class="flex flex-col gap-1">
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Golf Club"/><span>Golf Club</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Casino"/><span>Casino</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="SD"/><span>SD</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="SSMC"/><span>SSMC</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="LSMD"/><span>LSMD</span></label>
</div>
</div>
<div class="rounded-xl hairline p-2">
<h6 class="font-medium text-xs mb-1 opacity-70">25/25</h6>
<div class="flex flex-col gap-1">
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="DDJ"/><span>DDJ</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Army"/><span>Army</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Ranger"/><span>Ranger</span></label>
<label class="inline-flex items-center gap-2"><input class="accent-[color:var(--accent)]" name="company" onchange="berechne()" type="radio" value="Alcatraz"/><span>Alcatraz</span></label>
</div>
</div>
</div>
</div>
</div>
<div class="flex flex-col items-center justify-center flex-1 text-center">
<img alt="Logo" class="rounded-2xl hairline shadow-sm mb-2 h-[150px] w-[150px] object-cover" id="headerImage" src="https://s14.gifyu.com/images/bwJQn.png"/>
<h2 class="text-3xl md:text-4xl font-extrabold tracking-tight text-[color:var(--accent)] whitespace-nowrap" id="calculatorTitle">Play UP</h2>
<div class="mt-3">
<h4 class="text-sm font-semibold uppercase tracking-wide text-zinc-600 dark:text-zinc-300 text-center">Bestellseiten</h4>
<div class="tabs-container mt-2 inline-flex" id="tabsContainer">
<div class="tabs-slider" id="tabsSlider"></div>
<button class="tab-button" data-tab="1">1</button>
<button class="tab-button" data-tab="2">2</button>
<button class="tab-button" data-tab="3">3</button>
<button class="tab-button" data-tab="4">4</button>
<button class="tab-button" data-tab="5">5</button>
</div>
</div>
</div>
<div class="flex-1 min-w-0"></div>
</div>
<div id="calculatorContent">
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-6" id="categoriesGrid"></div>
<div class="hairline rounded-2xl p-4 sm:p-5 bg-black/[.03] dark:bg-white/[.06] mb-4 space-y-3">
<div class="flex items-center justify-between">
<div class="font-semibold text-base flex items-center gap-2">
<span class="opacity-70">Grund:</span>
<span class="text-sm font-normal opacity-90" id="grund">Noch nichts berechnet</span>
</div>
<button class="text-[color:var(--accent)] text-xl" onclick="copyText('grund')" title="Kopieren">üìÑ</button>
</div>
<hr class="border-t hairline border-0"/>
<div class="flex items-center justify-between">
<div class="font-semibold text-base flex items-center gap-2">
<span class="opacity-70">Preis:</span>
<span class="text-lg font-bold text-[color:var(--accent)]" id="preis">0$</span>
</div>
<div class="flex items-center gap-2">
<button class="text-[color:var(--accent)] text-xl" onclick="copyPriceText()" title="Kopieren">üìÑ</button>
<button class="px-3 py-1.5 rounded-full bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold whitespace-nowrap" onclick="applyLutaloRabatt()">Lutalo Rabatt ‚ù§Ô∏è</button>
</div>
</div>
</div>
<div class="text-sm text-green-600 dark:text-green-400 text-center hidden mt-4" id="kopiertHinweis">Kopiert ‚úÖ</div>
<div class="mt-6 grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-6">
<div></div>
<div class="flex items-center justify-center gap-3">
<label class="text-sm font-semibold opacity-80 whitespace-nowrap">Personen:</label>
<div class="quantity-control">
<button aria-label="Weniger" onclick="changeQuantity('personCountInput', -1)">‚àí</button>
<input id="personCountInput" min="0" oninput="berechne()" type="number" value="0"/>
<button aria-label="Mehr" onclick="changeQuantity('personCountInput', 1)">+</button>
</div>
</div>
<div class="justify-self-center sm:justify-self-end flex items-center gap-2">
<button class="px-5 py-2.5 rounded-full font-semibold bg-red-600 text-white hover:bg-red-700 shadow-sm" onclick="resetRechner()">
              Reset üóëÔ∏è
            </button>
<button class="px-5 py-2.5 rounded-full font-semibold bg-black/10 dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20 shadow-sm" onclick="undoLast()">
              Revoke ‚Ü©Ô∏è
            </button>
</div>
</div>
</div>
</div>
</div>

<!-- üß© Treuepunkte System -->
<div class="surface w-full max-w-3xl mx-auto p-6 mt-10 shadow-md border border-black/10 dark:border-white/10 rounded-2xl">
  <h3 class="text-2xl font-extrabold text-[color:var(--accent)] mb-4 flex items-center gap-2">üéÅ Treuepunkte System</h3>

  <div class="flex flex-col sm:flex-row gap-3 mb-6">
    <input id="punkteName" type="text" placeholder="Kundenname" class="flex-1 p-3 rounded-full hairline bg-black/5 dark:bg-white/10 focus:ring-2 focus:ring-[color:var(--accent)] outline-none transition"/>
    <input id="punkteAnzahl" type="number" placeholder="Punkte" class="w-32 p-3 rounded-full hairline bg-black/5 dark:bg-white/10 focus:ring-2 focus:ring-[color:var(--accent)] outline-none transition"/>
    <button onclick="addPunkte()" class="bg-[color:var(--accent)] hover:opacity-90 text-white font-semibold px-6 py-3 rounded-full shadow transition">Hinzuf√ºgen</button>
  </div>

  <div id="punkteListe" class="bg-black/5 dark:bg-white/10 rounded-2xl p-4 text-sm shadow-inner border border-black/10 dark:border-white/10">
    Noch keine Punkte vergeben.
  </div>
</div>

<script>
   
    const PASSWORD = "fickdeinemutterwenndudenkstdukannsthierpwauslesen";
    const STORAGE_KEY = "lutalo.config";
    const SALES_KEY   = "lutalo.sales";
    const THEME_KEY   = "lutalo.theme";
    const DARKMODE_KEY = "darkmode";
    const DEFAULT_IMAGE_URL = "https://s12.gifyu.com/images/b3dSM.png";
    const PUNKTE_KEY = "treuepunkte";
    const itemsPerPerson = 5;
    const numTabs = 5;

    let activeTab = 1;
    let calculatorStates = {};
    let undoStack = [];

  
    const THEMES = {
      "PlayUp Farben": {
        accent: "#4B0082",
        light: "radial-gradient(1200px 600px at 10% -10%, #f5f5f7, #fff) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #111113, #000) fixed"
      },
      "Retro": {
        accent: "#d97706",
        light: "radial-gradient(1000px 500px at 10% -10%, #fff7e6, #fef3c7) fixed",
        dark:  "radial-gradient(1000px 500px at 10% -10%, #4a3412, #1f1303) fixed"
      },
      "Nein": {
        accent: "#dc2626",
        light: "radial-gradient(1200px 600px at 10% -10%, #ffffff, #ffe4e6) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #200, #000) fixed"
      },
      "Alt": {
        accent: "#065f46",
        light: "radial-gradient(1200px 600px at 10% -10%, #f0fdf4, #ecfdf5) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #052e16, #000) fixed"
      },
      "Widwos 7": {
        accent: "#2563eb",
        light: "linear-gradient(#cfe8ff,#ffffff) fixed",
        dark:  "linear-gradient(#0a1a3a,#000000) fixed"
      },
      "Widwos 11": {
        accent: "#0ea5e9",
        light: "radial-gradient(circle at 20% 20%, #e0f7ff 0%, #ffffff 60%) fixed",
        dark:  "radial-gradient(circle at 20% 20%, #0a2530 0%, #000 60%) fixed"
      },
      "Lutalo Purple": {
        accent: "#8b5cf6",
        light: "radial-gradient(1200px 600px at 10% -10%, #f4f0ff, #fff) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #1a102a, #000) fixed"
      },
      "Ocean Blue": {
        accent: "#14b8a6",
        light: "radial-gradient(1200px 600px at 10% -10%, #ecfeff, #f0fdfa) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #002b2b, #000) fixed"
      },
      "Cyber Dark": {
        accent: "#00ff80",
        light: "radial-gradient(1200px 600px at 10% -10%, #1a1a1a, #000) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #000, #000) fixed"
      },
      "Clean White": {
        accent: "#000000",
        light: "linear-gradient(#ffffff,#ffffff) fixed",
        dark:  "linear-gradient(#000000,#000000) fixed"
      },
      "Arcade": {
        accent: "#a3e635",
        light: "radial-gradient(1200px 600px at 10% -10%, #1a1a1a 0%, #000 60%) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #000000 0%, #000000 60%) fixed"
      },
      "Terminal Green": {
        accent: "#39ff14",
        light: "radial-gradient(1200px 600px at 10% -10%, #000000, #001100) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #000000, #000000) fixed"
      },
      "Candy Pop": {
        accent: "#ff4da6",
        light: "radial-gradient(circle at 20% 20%, #fff0fa 0%, #fff 60%) fixed",
        dark:  "radial-gradient(circle at 20% 20%, #2a001a 0%, #000 60%) fixed"
      },
      "Sunset": {
        accent: "#fb923c",
        light: "radial-gradient(circle at 20% 20%, #fff1e6 0%, #ffe4e6 60%) fixed",
        dark:  "radial-gradient(circle at 20% 20%, #2b0a00 0%, #000 60%) fixed"
      },
      "Vaporwave": {
        accent: "#ff00ff",
        light: "radial-gradient(circle at 20% 20%, #ffe6ff 0%, #e0f7ff 60%) fixed",
        dark:  "radial-gradient(circle at 20% 20%, #1a002b 0%, #00001a 60%) fixed"
      },
      "Fresh Mint": {
        accent: "#00d897",
        light: "radial-gradient(1200px 600px at 10% -10%, #f0fff4, #ecfff8) fixed",
        dark:  "radial-gradient(1200px 600px at 10% -10%, #001a12, #000) fixed"
      }
    };

    function populateThemeSelect() {
      const sel = document.getElementById("themeSelect");
      sel.innerHTML = "";
      Object.keys(THEMES).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
      sel.addEventListener("change", () => {
        applyTheme(sel.value);
        saveTheme(sel.value);
      });
    }

    function applyTheme(themeName) {
      const theme = THEMES[themeName] || THEMES["PlayUp Farben"];
   
      document.documentElement.style.setProperty("--accent", theme.accent);

   
      const isDark = document.body.classList.contains("dark");
      if (isDark) {
        document.documentElement.style.setProperty("--bg-dark", theme.dark);
        document.documentElement.style.setProperty("--bg-light", theme.light);
      } else {
        document.documentElement.style.setProperty("--bg-light", theme.light);
        document.documentElement.style.setProperty("--bg-dark", theme.dark);
      }

   
      document.querySelectorAll('#preis, #calculatorTitle, .text-[color\\:var\\(--accent\\)]').forEach(el => {
        el.style.color = theme.accent;
      });

   
    }

    function saveTheme(name) {
      localStorage.setItem(THEME_KEY, name);
    }

    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY) || "PlayUp Farben";
      const sel = document.getElementById("themeSelect");
      if (sel) sel.value = saved;
      applyTheme(saved);
    }

   
    const companyLimits = {
      "Golf Club": { maxFood: 50, maxDrink: 50 },
      "Casino": { maxFood: 50, maxDrink: 50 },
      "SD": { maxFood: 50, maxDrink: 50 },
      "Army": { maxFood: 25, maxDrink: 25 },
      "Ranger": { maxFood: 25, maxDrink: 25 },
      "Tuner": { maxFood: 10, maxDrink: 10 },
      "SSMC": { maxFood: 50, maxDrink: 50 },
      "LSMD": { maxFood: 50, maxDrink: 50 },
      "Alcatraz": { maxFood: 25, maxDrink: 25 },
      "DDJ": { maxFood: 25, maxDrink: 25 }
    };


    const defaultPreise = {
      popup: { name: 'Pop UP', price: 300, category: 'ESSEN', id: 'popup' },
      burnup: { name: 'Burn UP', price: 300, category: 'ESSEN', id: 'burnup' },
      jellyup: { name: 'Jelly UP', price: 200, category: 'ESSEN', id: 'jellyup'},
      gumup: { name: 'Gum UP', price: 200, category: 'ESSEN', id: 'gumup' },

      boostup: { name: 'Boost UP', price: 200, category: 'TRINKEN', id: 'boostup' },
      powerup: { name: 'Power UP', price: 200, category: 'TRINKEN', id: 'powerup' },
      spritzup: { name: 'Spritz UP', price: 175, category: 'TRINKEN', id: 'spritzup' },

      gutschein3: { name: 'Standard Figur', price: 150000, category: 'FIGUREN', id: 'gutschein3' },
      gutschein5: { name: 'Couple Figuren', price: 200000, category: 'FIGUREN', id: 'gutschein5' },
      gutschein6: { name: 'Figuren Accessoires', price: 30000, category: 'FIGUREN', id: 'gutschein6' },
      gutschein7: { name: 'Figuren Glow', price: 20000, category: 'FIGUREN', id: 'gutschein7' },
      gutschein8: { name: 'Figuren Seltenheit', price: 20000, category: 'FIGUREN', id: 'gutschein8' },

      coins: { name: 'Play UP Coin', price: 200, category: 'COINS', id: 'coins' },
      coins1: { name: '100x Play UP Coin', price: 18000, category: 'COINS', id: 'coins1' },


      gutschein1: { name: '1 Sticker', price: 5000, category: 'STICKER', id: 'gutschein1' },
      gutschein2: { name: '5 Sticker', price: 23000, category: 'STICKER', id: 'gutschein2' },
    


    };

    
    let currentPreise = {};
    let categories = ['ESSEN', 'TRINKEN', 'COINS', 'STICKER', 'FIGUREN'];
    let foodCategories = ['ESSEN'];
    let drinkCategories = ['TRINKEN', 'ALKOHOL'];
    let rauchwarenCategories = ['COINS'];
    let miscellaneousCategories = ['STICKER', 'FIGUREN'];
    let customTitle = 'Play UP Kassenblatt';
    let customImage = DEFAULT_IMAGE_URL;
    let previousCustomers = [];


    function todayKey() {
      const t = new Date();
      const d = String(t.getDate()).padStart(2,'0');
      const m = String(t.getMonth()+1).padStart(2,'0');
      const y = t.getFullYear();
      return `${y}-${m}-${d}`;
    }
    function todayPretty() {
      const t = new Date();
      const d = String(t.getDate()).padStart(2,'0');
      const m = String(t.getMonth()+1).padStart(2,'0');
      return `${d}.${m}.`;
    }

    function initDarkToggle() {
      const toggle = document.getElementById('themeToggle');
      const saved = localStorage.getItem(DARKMODE_KEY);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const startDark = saved ? (saved === 'dark') : prefersDark;
      document.documentElement.classList.toggle('dark', startDark);
      document.body.classList.toggle('dark', startDark);
      toggle.checked = startDark;

      toggle.addEventListener('change', () => {
        const nowDark = document.documentElement.classList.toggle('dark');
        document.body.classList.toggle('dark', nowDark);
        localStorage.setItem(DARKMODE_KEY, nowDark ? 'dark' : 'light');

        const currentTheme = document.getElementById("themeSelect").value || "PlayUp Farben";
        applyTheme(currentTheme);
      });
    }

    
    function applyConfig(data) {
      currentPreise = data.items || { ...defaultPreise };
      categories = data.categories || ['ESSEN', 'TRINKEN', 'FIGUREN', 'COINS', 'STICKER'];
      foodCategories = data.foodCategories || ['ESSEN'];
      drinkCategories = data.drinkCategories || ['TRINKEN', 'ALKOHOL'];
      rauchwarenCategories = data.rauchwarenCategories || ['COINS'];
      miscellaneousCategories = data.miscellaneousCategories || ['STICKER', 'FIGUREN'];
      customTitle = data.title || 'Play UP Kassenblatt';
      customImage = data.image || DEFAULT_IMAGE_URL;
    }

    function getConfig() {
      return {
        items: currentPreise,
        categories,
        foodCategories,
        drinkCategories,
        rauchwarenCategories,
        miscellaneousCategories,
        title: customTitle,
        image: customImage
      };
    }

    function loadPreise() {
      applyConfig({
        items: { ...defaultPreise },
        categories: ['ESSEN', 'TRINKEN', 'FIGUREN', 'COINS', 'STICKER'],
        foodCategories: ['ESSEN'],
        drinkCategories: ['TRINKEN', 'ALKOHOL'],
        rauchwarenCategories: ['COINS'],
        miscellaneousCategories: ['STICKER', 'FIGUREN'],
        title: customTitle,
        image: DEFAULT_IMAGE_URL
      });
      renderCalculatorInputs();
      updateHeaderDisplay();
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          applyConfig(data);
          renderCalculatorInputs();
          updateHeaderDisplay();
        }
      } catch(e){ console.error(e); }
    }

    function savePreise() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(getConfig()));
    }

    function updateHeaderDisplay() {
      document.getElementById('htmlTitle').innerText = customTitle;
      document.getElementById('calculatorTitle').innerText = customTitle;
      document.getElementById('headerImage').src = customImage;
      requestAnimationFrame(()=>{
        document.getElementById('headerImage').classList.add('loaded');
      });
    }

    
    function renderCalculatorInputs() {
      const grid = document.getElementById('categoriesGrid');
      grid.innerHTML = '';
      categories.forEach(category => {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <h3 class="text-base font-bold mb-3 text-center tracking-wide">${category.toUpperCase()}</h3>
          <div class="space-y-3"></div>
        `;
        grid.appendChild(wrap);
        const listEl = wrap.querySelector('.space-y-3');
        const items = Object.values(currentPreise).filter(i => i.category === category);
        items.forEach(item => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between gap-4';
          row.innerHTML = `
            <div class="min-w-0">
              <label for="${item.id}" class="font-medium">${item.name}</label>
              <div class="text-xs opacity-70">${item.price}$</div>
            </div>
            <div class="quantity-control">
              <button onclick="changeQuantity('${item.id}', -1)">‚àí</button>
              <input id="${item.id}" type="number" min="0" value="0" oninput="berechne()" />
              <button onclick="changeQuantity('${item.id}', 1)">+</button>
            </div>
          `;
          listEl.appendChild(row);
        });
      });
    }

    function changeQuantity(id, delta) {
  const input = document.getElementById(id);
  if (!input) return;
  let v = parseInt(input.value) || 0;
  v += delta;
  if (v < 0) v = 0;
  input.value = v;
  berechne();


  input.classList.remove('updated');
  void input.offsetWidth; 
  input.classList.add('updated');
}

  
    function initializeCalculatorStates() {
      for (let i=1;i<=numTabs;i++) {
        calculatorStates[i] = {
          inputs:{},
          grund:'Noch nichts berechnet',
          preis:'0$',
          personCount:'0'
        };
      }
      const saved = localStorage.getItem('calculatorStates');
      if (saved) {
        const parsed = JSON.parse(saved);
        for (const t in parsed) {
          if (calculatorStates[t]) calculatorStates[t] = parsed[t];
        }
      }
    }

    function captureCurrentState() {
      const inputs = {};
      document.querySelectorAll('#calculatorContent input[type="number"]').forEach(i => {
        inputs[i.id] = i.value;
      });
      return {
        activeTab,
        inputs,
        grund: document.getElementById('grund').innerText,
        preis: document.getElementById('preis').innerText,
        personCount: document.getElementById('personCountInput').value
      };
    }

    function pushUndoSnapshot() {
      undoStack.push(captureCurrentState());
      if (undoStack.length > 20) undoStack.shift();
    }

    function restoreStateSnapshot(snap) {
      activeTab = snap.activeTab || activeTab;
      document.querySelectorAll('#calculatorContent input[type="number"]').forEach(i => i.value = 0);
      for (const id in snap.inputs) {
        const el = document.getElementById(id);
        if (el) el.value = snap.inputs[id];
      }
      document.getElementById('grund').innerText = snap.grund;
      document.getElementById('preis').innerText = snap.preis;
      document.getElementById('personCountInput').value = snap.personCount;
    }

    function undoLast() {
      if (!undoStack.length) return;
      const snap = undoStack.pop();
      restoreStateSnapshot(snap);
      saveCalculatorState();
      updateUIFromState();
    }

    function saveCalculatorState() {
      const s = { inputs:{} };
      document.querySelectorAll('#calculatorContent input[type="number"]').forEach(i => {
        s.inputs[i.id] = i.value;
      });
      s.grund = document.getElementById('grund').innerText;
      s.preis = document.getElementById('preis').innerText;
      s.personCount = document.getElementById('personCountInput').value;
      calculatorStates[activeTab] = s;
      localStorage.setItem('calculatorStates', JSON.stringify(calculatorStates));
    }

    function loadCalculatorStateForTab() {
      const s = calculatorStates[activeTab];
      document.querySelectorAll('#calculatorContent input[type="number"]').forEach(i => i.value = 0);
      if (s) {
        for (const id in s.inputs) {
          const el = document.getElementById(id);
          if (el) el.value = s.inputs[id];
        }
        document.getElementById('grund').innerText = s.grund;
        document.getElementById('preis').innerText = s.preis;
        document.getElementById('personCountInput').value = s.personCount || 0;
      } else {
        document.getElementById('grund').innerText = 'Noch nichts berechnet';
        document.getElementById('preis').innerText = '0$';
        document.getElementById('personCountInput').value = 0;
      }
    }

    function updateSliderPosition(tabButton) {
      const slider = document.getElementById('tabsSlider');
      const container = document.getElementById('tabsContainer');
      const b = tabButton.getBoundingClientRect();
      const c = container.getBoundingClientRect();
      slider.style.setProperty('--tab-left', `${b.left - c.left}px`);
      slider.style.setProperty('--tab-width', `${b.width}px`);
    }

    function switchTab(tabNumber) {
      if (tabNumber === activeTab) return;
      saveCalculatorState();
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      const newBtn = document.querySelector(`.tab-button[data-tab=\"${tabNumber}\"]`);
      if (newBtn) {
        newBtn.classList.add('active');
        updateSliderPosition(newBtn);
      }
      activeTab = tabNumber;
      loadCalculatorStateForTab();
      berechne();
      localStorage.setItem('activeTab', tabNumber);
    }

    function updateUIFromState() {
      loadCalculatorStateForTab();
    }

  
    function loadSales() {
      try {
        const raw = localStorage.getItem(SALES_KEY);
        if (raw) return JSON.parse(raw);
      } catch(e){}
      return {};
    }

    function saveSales(obj) {
      localStorage.setItem(SALES_KEY, JSON.stringify(obj));
    }

 
    function recordSale(grund, betrag) {
      const key = todayKey();
      const sales = loadSales();
      if (!sales[key]) {
        sales[key] = { total: 0, entries: [] };
      }
      sales[key].total += betrag;
      sales[key].entries.push({ grund, betrag, ts: Date.now() });
      saveSales(sales);
    }

    function listSalesForUI() {
      const sales = loadSales();
      const rows = [];
      Object.keys(sales).sort().forEach(dayKey => {
        rows.push(`üìÖ ${dayKey} ‚Äî Total: ${sales[dayKey].total}$`);
        sales[dayKey].entries.forEach(e => {
          rows.push(` ‚Ä¢ ${e.betrag}$ | ${e.grund}`);
        });
      });
      return rows;
    }

    function buildStatsChart() {
      const ctx = document.getElementById('statsChart');
      if (!ctx) return;
      const sales = loadSales();
      const labels = [];
      const data = [];

      Object.keys(sales).sort().forEach(dayKey => {
        labels.push(dayKey);
        data.push(sales[dayKey].total);
      });

      if (window._statsChart) {
        window._statsChart.data.labels = labels;
        window._statsChart.data.datasets[0].data = data;
        window._statsChart.update('active');
      } else {
        window._statsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Umsatz pro Tag ($)',
              data: data
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#999' } } },
            scales: {
              x: { ticks: { color: '#999' } },
              y: { beginAtZero: true, ticks: { color: '#999' } }
            }
          }
        });
      }

      document.getElementById('statsList').innerText = listSalesForUI().join('\n');
      const topProducts = getTopProducts();
      document.getElementById('statsList').innerText += "\n\nüèÜ Top 3 Produkte:\n" + topProducts;

    }

    

function getTopProducts() {
  const sales = loadSales();
  const productCounts = {};

  Object.values(sales).forEach(day => {
    day.entries.forEach(entry => {
      const match = entry.grund.match(/(\d+)x ([^+|]+)/g);
      if (match) {
        match.forEach(item => {
          const parts = item.match(/(\d+)x (.+)/);
          if (!parts) return;
          const qty = parseInt(parts[1]);
          const name = parts[2].trim();
          productCounts[name] = (productCounts[name] || 0) + qty;
        });
      }
    });
  });

  const sorted = Object.entries(productCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);

  if (sorted.length === 0) return "Keine Verk√§ufe bisher.";

  return sorted.map(([name, count]) => `${name} (${count}x)`).join("<br>");
}

function toggleTopProductsDropdown() {
  const dropdown = document.getElementById('topProductsDropdown');
  dropdown.classList.toggle('show');
}

function updateTopProductsDropdown() {
  const listEl = document.getElementById('topProductsList');
  if (!listEl) return;
  const topProducts = getTopProducts();
  listEl.innerHTML = topProducts;
}

function loadProductStats() {
  try {
    const raw = localStorage.getItem('lutalo.productStats');
    if (raw) return JSON.parse(raw);
  } catch(e){}
  return {};
}

function saveProductStats(stats) {
  localStorage.setItem('lutalo.productStats', JSON.stringify(stats));
}

function recordProductSale(grund, betrag) {
  const stats = loadProductStats();
  const match = grund.match(/(\d+)x ([^+|]+)/g);
  if (match) {
    match.forEach(item => {
      const parts = item.match(/(\d+)x (.+)/);
      if (!parts) return;
      const qty = parseInt(parts[1]);
      const name = parts[2].trim();
      const found = Object.values(currentPreise).find(i => i.name === name);
      const pricePerItem = found ? found.price : 0;
      const amount = qty * pricePerItem;
      stats[name] = (stats[name] || 0) + amount;
    });
  }
  saveProductStats(stats);
}

function buildProductStatsChart() {
  const ctx = document.getElementById('productStatsChart');
  if (!ctx) return;
  const stats = loadProductStats();
  const labels = Object.keys(stats);
  const data = Object.values(stats);

  if (window._productStatsChart) {
    window._productStatsChart.data.labels = labels;
    window._productStatsChart.data.datasets[0].data = data;
    window._productStatsChart.update('active');
  } else {
    window._productStatsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Umsatz pro Produkt ($)',
          data: data
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#999' } } },
        scales: {
          x: { ticks: { color: '#999' } },
          y: { beginAtZero: true, ticks: { color: '#999' } }
        }
      }
    });
  }
}

function resetProductStats() {
  if (!confirm('Produktstatistik wirklich l√∂schen?')) return;
  
  fetch('/api/stats', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ scope: 'products' })
  }).then(() => {
    localStorage.removeItem('lutalo.productStats');
    buildProductStatsChart();
    showNotification('Produktstatistik gel√∂scht! üóëÔ∏è', 'success');
  }).catch(err => {
    console.error('Error deleting product stats:', err);
    localStorage.removeItem('lutalo.productStats');
    buildProductStatsChart();
    showNotification('Produktstatistik gel√∂scht (Offline)', 'warning');
  });
}

function openStats() {
  document.getElementById('statsModal').style.display = 'flex';
  buildStatsChart();
  buildProductStatsChart();
  updateTopProductsDropdown();
}
function closeStats() {
  document.getElementById('statsModal').style.display = 'none';
}
function resetStats() {
  if (!confirm('Verlauf wirklich l√∂schen?')) return;
  
  fetch('/api/stats', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ scope: 'all' })
  }).then(() => {
    localStorage.removeItem(SALES_KEY);
    buildStatsChart();
    buildProductStatsChart();
    updateTopProductsDropdown();
    showNotification('Alle Statistiken gel√∂scht! üóëÔ∏è', 'success');
  }).catch(err => {
    console.error('Error deleting stats:', err);
    localStorage.removeItem(SALES_KEY);
    buildStatsChart();
    buildProductStatsChart();
    updateTopProductsDropdown();
    showNotification('Statistiken gel√∂scht (Offline)', 'warning');
  });
}

function showReceipt(grund, betrag, rabatt=false) {
  const receipt = document.getElementById('receiptPopup');
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');

  receipt.innerHTML = `
    <div class="font-bold text-center mb-2">${customTitle}</div>
    <div>${todayPretty()} ${hh}:${mm}</div>
    <div class="mt-2 break-words">${grund}</div>
    <div class="mt-2 font-bold text-right">${betrag}$</div>
    ${rabatt ? '<div class="text-purple-600 font-bold text-right">Lutalo Rabatt ‚úî</div>' : ''}
  `;

  receipt.classList.add('showing');

  setTimeout(()=>{
    receipt.classList.remove('showing');
    receipt.style.display = 'none';
  },3000);
}

function copyToClipboard(text) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => showCopied());
  } else {
    const t = document.createElement('textarea');
    t.value = text;
    t.style.position='fixed';
    t.style.left='-9999px';
    document.body.appendChild(t);
    t.select();
    try { document.execCommand('copy'); showCopied(); } catch(e) {}
    document.body.removeChild(t);
  }
}
function showCopied(){
  const h = document.getElementById('kopiertHinweis');
  h.classList.remove('hidden');
  setTimeout(()=>h.classList.add('hidden'),2000);
}
function copyText(id){ 
  copyToClipboard(document.getElementById(id).innerText);
  if (id === 'grund') {
    const grund = document.getElementById('grund').innerText;
    const preisText = document.getElementById('preis').innerText;
    const preisNum = parseInt(preisText.replace('$','')) || 0;
    if (preisNum > 0) {
      recordSale(grund, preisNum);
      recordProductSale(grund, preisNum);
      showReceipt(grund, preisNum);
      buildStatsChart();
      buildProductStatsChart();
      updateTopProductsDropdown();
    }
  }
}
function copyPriceText(){ 
  copyToClipboard(document.getElementById('preis').innerText.replace('$',''));
  const grund = document.getElementById('grund').innerText;
  const preisNum = parseInt(document.getElementById('preis').innerText.replace('$','')) || 0;
  if (preisNum > 0) {
    recordSale(grund, preisNum);
    recordProductSale(grund, preisNum);
    showReceipt(grund, preisNum);
    buildStatsChart();
    buildProductStatsChart();
    updateTopProductsDropdown();
  }
}

function resetRechner() {
  pushUndoSnapshot();
  document.getElementById('personCountInput').value = 0;
  document.querySelectorAll('#calculatorContent input[type="number"]').forEach(inp => inp.value = 0);
  document.getElementById('grund').innerText = 'Noch nichts berechnet';
  document.getElementById('preis').innerText = '0$';
  saveCalculatorState();
}

function applyLutaloRabatt() {
  pushUndoSnapshot();
  const grundEl = document.getElementById('grund');
  const preisEl = document.getElementById('preis');

  const altGrund = grundEl.innerText;
  const rabattGrund = altGrund.includes('[Lutalo Rabatt]') ? altGrund : altGrund + ' | [Lutalo Rabatt]';
  grundEl.innerText = rabattGrund;
  preisEl.innerText = '1$';

  saveCalculatorState();

  preisEl.style.color = '#8b5cf6';
  setTimeout(()=>{ preisEl.style.color = ''; },600);
}

function berechne() {
  pushUndoSnapshot();

  let summe = 0, foodCount = 0, drinkCount = 0, rauchwarenCount = 0;
  const orderedItems = [], miscItems = [];

  const companyInput = document.querySelector('input[name="company"]:checked');
  const selectedCompany = companyInput ? companyInput.value : "";
  const isCompanyOrder = selectedCompany !== "";
  const companyLimit = companyLimits[selectedCompany];

  const manualPersonCount = parseInt(document.getElementById('personCountInput').value) || 0;

  for (const key in currentPreise) {
    const el = document.getElementById(key);
    if (!el) continue;
    const anzahl = parseInt(el.value) || 0;
    if (!anzahl) continue;

    summe += anzahl * currentPreise[key].price;
    const cat = currentPreise[key].category;
    const line = `${anzahl}x ${currentPreise[key].name}`;

    if (foodCategories.includes(cat)) { foodCount += anzahl; orderedItems.push(line); }
    else if (drinkCategories.includes(cat)) { drinkCount += anzahl; orderedItems.push(line); }
    else if (rauchwarenCategories.includes(cat)) { rauchwarenCount += anzahl; orderedItems.push(line); }
    else if (miscellaneousCategories.includes(cat)) { miscItems.push(line); }
  }

  document.getElementById('preis').innerText = `${summe}$`;

  let grund = '';
  const totalItems = foodCount + drinkCount + rauchwarenCount + miscItems.length;
  const dateString = todayPretty();

  if (totalItems > 0 || manualPersonCount > 0) {
    const overText = [];
    if (isCompanyOrder && companyLimit) {
      if (foodCount > companyLimit.maxFood)  overText.push(`Essen √ºberschreitet Limit (${foodCount}/${companyLimit.maxFood})!`);
      if (drinkCount > companyLimit.maxDrink) overText.push(`Trinken √ºberschreitet Limit (${drinkCount}/${companyLimit.maxDrink})!`);
    }

    const parts = [`PlayUP | ${dateString}`];
    if (isCompanyOrder) {
      parts.push(`Kantine ${selectedCompany}`);
    } else if (manualPersonCount > 0) {
      parts.push(`${manualPersonCount}P`);
    } else {
      const pc = Math.max(foodCount, drinkCount) > 0 ? Math.ceil(Math.max(foodCount, drinkCount) / itemsPerPerson) : 0;
      if (pc > 0) parts.push(`${pc}P`);
    }

    const allItems = [...orderedItems, ...miscItems];
    if (allItems.length > 0) parts.push(allItems.join(' + '));

    const cats = [];
    if (foodCount > 0) cats.push('Essen');
    if (drinkCount > 0) cats.push('Trinken');
    if (rauchwarenCount > 0) cats.push('Coins');
    if (cats.length > 0) parts.push(cats.join(' & '));

    if (overText.length > 0) {
      parts.push(`‚ö†Ô∏è${overText.join(' ')}`);
    }

    grund = parts.join(' | ');
  } else {
    grund = 'Noch nichts berechnet';
  }

  document.getElementById('grund').innerText = grund;
  saveCalculatorState();

  const preisText = document.getElementById('preis').innerText;
  const preisNum = parseInt(preisText.replace('$','')) || 0;
}

function toggleDropdown() {
  document.getElementById('unternehmenDropdown').classList.toggle('show');
}

function toggleRushHourDropdown() {
  const dropdown = document.getElementById('rushHourDropdown');
  dropdown.classList.toggle('show');
  if (dropdown.classList.contains('show')) buildRushHourChart();
}

function buildRushHourChart() {
  const ctx = document.getElementById('rushHourDropdownChart');
  if (!ctx) return;
  const sales = loadSales();
  const hourlyTotals = Array(24).fill(0);
  
  Object.values(sales).forEach(day => {
    if (day.entries) {
      day.entries.forEach(entry => {
        if (entry.ts) {
          const hour = new Date(entry.ts).getHours();
          hourlyTotals[hour] += entry.betrag;
        }
      });
    }
  });
  
  const labels = hourlyTotals.map((_, i) => i.toString().padStart(2,'0') + ':00');
  const top3 = [...hourlyTotals].sort((a,b)=>b-a).slice(0,3);
  const bgColors = hourlyTotals.map(v => top3.includes(v) ? 'rgba(255,99,132,0.8)' : 'rgba(75,0,130,0.5)');
  
  if (window._rushHourChart) {
    window._rushHourChart.data.labels = labels;
    window._rushHourChart.data.datasets[0].data = hourlyTotals;
    window._rushHourChart.data.datasets[0].backgroundColor = bgColors;
    window._rushHourChart.update('active');
  } else {
    window._rushHourChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Umsatz pro Stunde ($)',
          data: hourlyTotals,
          backgroundColor: bgColors
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#999' } },
          y: { beginAtZero: true, ticks: { color: '#999' } }
        }
      }
    });
  }
}

function closeWelcome() {
  const modal = document.getElementById('welcomeModal');
  if (modal) {
    modal.style.opacity = '1';
    modal.style.transition = 'opacity 0.5s ease';
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.style.display = 'none';
    }, 500);
  }
}

document.getElementById('versionBadge').addEventListener('click', ()=>{
  document.getElementById('changelogModal').style.display = 'flex';
});
function closeChangelog(){
  document.getElementById('changelogModal').style.display = 'none';
}

// Treuepunkte Functions
function loadPunkte() {
  try {
    const raw = localStorage.getItem(PUNKTE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch(e){ return {}; }
}

function savePunkte(data) {
  localStorage.setItem(PUNKTE_KEY, JSON.stringify(data));
}

window.addPunkte = async function() {
  const nameEl = document.getElementById("punkteName");
  const punkteEl = document.getElementById("punkteAnzahl");
  const name = nameEl.value.trim();
  const punkte = parseInt(punkteEl.value);

  if (!name || isNaN(punkte)) {
    showNotification("Bitte Namen und Punktezahl eingeben!", "warning");
    return;
  }

  try {
    const response = await fetch('/api/loyalty', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, points: punkte })
    });

    if (!response.ok) {
      throw new Error('API call failed');
    }

    const result = await response.json();
    
    const daten = loadPunkte();
    daten[name] = (daten[name] || 0) + punkte;
    savePunkte(daten);
    
    renderPunkteListe();

    showNotification(`${punkte} Punkte an ${name} vergeben! üéÅ`, "success");

    nameEl.value = "";
    punkteEl.value = "";
    
  } catch (error) {
    console.error('Error adding points:', error);
    
    const daten = loadPunkte();
    const oldPoints = daten[name] || 0;
    daten[name] = oldPoints + punkte;
    savePunkte(daten);
    renderPunkteListe();
    
    const customer = {
      name: name,
      points: daten[name],
      pointsChange: punkte,
      level: calculateLevelForPoints(daten[name])
    };
    
    showLoyaltyPointsAnimation(customer);
    
    const oldLevel = calculateLevelForPoints(oldPoints);
    const newLevel = calculateLevelForPoints(daten[name]);
    
    if (oldLevel !== newLevel) {
      setTimeout(() => {
        showLevelUpCelebration(customer);
      }, 500);
    }
    
    showNotification(`${punkte} Punkte an ${name} vergeben! (Offline-Modus)`, "warning");
    
    nameEl.value = "";
    punkteEl.value = "";
  }
};

function renderPunkteListe() {
  const daten = loadPunkte();
  const listEl = document.getElementById("punkteListe");

  if (Object.keys(daten).length === 0) {
    listEl.innerHTML = "Noch keine Punkte vergeben.";
    return;
  }

  const customers = Object.entries(daten).map(([name, points]) => ({
    name,
    points
  })).sort((a, b) => b.points - a.points);
  
  const totalCustomers = customers.length;
  const totalPoints = customers.reduce((sum, c) => sum + c.points, 0);
  const avgPoints = totalPoints / totalCustomers;
  
  listEl.innerHTML = `
    <div class="loyalty-statistics mb-4 p-3 bg-black/5 dark:bg-white/10 rounded-lg">
      <div class="grid grid-cols-3 gap-2 text-sm">
        <div>
          <div class="opacity-70">Kunden</div>
          <div class="font-bold text-lg">${totalCustomers}</div>
        </div>
        <div>
          <div class="opacity-70">√ò Punkte</div>
          <div class="font-bold text-lg">${avgPoints.toFixed(1)}</div>
        </div>
        <div>
          <div class="opacity-70">Gesamt</div>
          <div class="font-bold text-lg">${totalPoints}</div>
        </div>
      </div>
    </div>
    
    <table class="w-full text-left text-sm">
      <thead>
        <tr class="border-b border-black/10 dark:border-white/10">
          <th class="py-2 font-semibold">Kunde</th>
          <th class="py-2 font-semibold">Punkte</th>
          <th class="py-2 font-semibold">Level</th>
          <th class="py-2"></th>
        </tr>
      </thead>
      <tbody>
        ${customers.map((customer, index) => {
          const level = calculateLevelForPoints(customer.points);
          return `
            <tr class="border-t border-black/10 dark:border-white/10 hover:bg-black/5 
                       dark:hover:bg-white/10 transition fade-in ${index < 3 ? 'top-customer' : ''}"
                data-customer="${customer.name}"
                style="animation-delay: ${index * 0.05}s">
              <td class="py-2 font-medium">
                ${index < 3 ? `<span class="rank-badge ${index === 0 ? 'rank-top' : ''}">${index + 1}</span>` : ''}
                ${customer.name}
              </td>
              <td class="py-2">
                <span class="points-badge ${getLevelClass(level)}">
                  ${customer.points} <span class="opacity-70">Pkt</span>
                </span>
              </td>
              <td class="py-2">
                <span class="level-badge ${getLevelClass(level)}">
                  ${getLevelIcon(level)} ${level}
                </span>
              </td>
              <td class="py-2 text-right">
                <button onclick="removePunkte('${customer.name}')" 
                        class="text-xs text-red-500 hover:text-red-700 font-semibold transition">
                  L√∂schen
                </button>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>`;
}

window.removePunkte = async function(name) {
  if (!confirm(`${name} wirklich aus der Treuepunkte-Liste l√∂schen?`)) {
    return;
  }
  
  try {
    const response = await fetch('/api/loyalty', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });

    if (!response.ok) {
      throw new Error('API call failed');
    }

    const daten = loadPunkte();
    delete daten[name];
    savePunkte(daten);
    
    renderPunkteListe();
    
    showNotification(`${name} wurde entfernt`, "info");
    
  } catch (error) {
    console.error('Error removing customer:', error);
    
    const daten = loadPunkte();
    delete daten[name];
    savePunkte(daten);
    renderPunkteListe();
    
    showNotification(`${name} wurde entfernt (Offline-Modus)`, "warning");
  }
};

window.calculateLevelForPoints = function(points) {
  if (points >= 200) return 'Platinum';
  if (points >= 150) return 'Gold';
  if (points >= 75) return 'Silver';
  return 'Bronze';
};

window.getLevelIcon = function(level) {
  const icons = {
    'Bronze': 'ü•â',
    'Silver': 'ü•à',
    'Gold': 'ü•á',
    'Platinum': 'üíé'
  };
  return icons[level] || 'üéÅ';
};

window.getLevelClass = function(level) {
  return `level-${level.toLowerCase()}`;
};

function showLoyaltyPointsAnimation(customer) {
  const row = document.querySelector(`[data-customer="${CSS.escape(customer.name)}"]`);
  
  const animation = document.createElement('div');
  animation.className = 'points-animation';
  animation.innerHTML = `+${customer.pointsChange} üéÅ`;
  
  if (row) {
    const rect = row.getBoundingClientRect();
    animation.style.left = (rect.left + rect.width / 2) + 'px';
    animation.style.top = rect.top + 'px';
  } else {
    animation.style.left = '50%';
    animation.style.top = '50%';
  }
  
  document.body.appendChild(animation);
  
  setTimeout(() => {
    animation.classList.add('animate');
    setTimeout(() => animation.remove(), 2000);
  }, 10);
  
  if (row) {
    row.classList.add('flash-highlight');
    setTimeout(() => row.classList.remove('flash-highlight'), 2000);
  }
}

function showLevelUpCelebration(customer) {
  const modal = document.createElement('div');
  modal.className = 'level-up-modal';
  modal.innerHTML = `
    <div class="level-up-content">
      <div class="confetti">üéâ</div>
      <h2>Level Up!</h2>
      <p><strong>${customer.name}</strong> hat das</p>
      <div class="new-level ${getLevelClass(customer.level)}">
        ${getLevelIcon(customer.level)} ${customer.level}-Level
      </div>
      <p>erreicht!</p>
      <button class="close-btn">Gro√üartig!</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  modal.querySelector('.close-btn').addEventListener('click', () => {
    modal.remove();
  });
  
  setTimeout(() => {
    if (modal.parentElement) {
      modal.remove();
    }
  }, 5000);
}

// ============================================
// LIVE UPDATES SYSTEM
// ============================================

window.showNotification = function(message, type = 'info', options = {}) {
  const { duration = 3000, action = null } = options;
  
  const existing = document.querySelector('.notification-toast');
  if (existing) {
    existing.remove();
  }
  
  const notification = document.createElement('div');
  notification.className = `notification-toast ${type}`;
  
  const icons = {
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    error: '‚ùå',
    info: '‚ÑπÔ∏è'
  };
  
  notification.innerHTML = `
    <span class="icon">${icons[type] || icons.info}</span>
    <span class="message">${message}</span>
    ${action ? `<button class="action-btn">${action.label}</button>` : ''}
    <button class="close-btn">√ó</button>
  `;
  
  document.body.appendChild(notification);
  
  if (action && action.callback) {
    const actionBtn = notification.querySelector('.action-btn');
    actionBtn.addEventListener('click', () => {
      action.callback();
      notification.remove();
    });
  }
  
  notification.querySelector('.close-btn').addEventListener('click', () => {
    notification.remove();
  });
  
  if (duration > 0) {
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => notification.remove(), 500);
    }, duration);
  }
  
  return notification;
};

// Socket.IO Live Updates Manager
class LiveUpdatesManager {
  constructor() {
    this.socket = null;
    this.isConnected = false;
    this.reconnectAttempts = 0;
    this.createConnectionIndicator();
  }
  
  createConnectionIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'connection-status hidden';
    indicator.innerHTML = `
      <div class="dot"></div>
      <span class="status-text">Verbunden</span>
    `;
    document.body.appendChild(indicator);
    this.indicator = indicator;
  }
  
  updateConnectionStatus(status) {
    this.indicator.className = `connection-status ${status}`;
    const statusTexts = {
      'connected': 'Live verbunden',
      'connecting': 'Verbinde...',
      'disconnected': 'Getrennt'
    };
    this.indicator.querySelector('.status-text').textContent = statusTexts[status] || '';
    
    if (status === 'connected') {
      setTimeout(() => {
        this.indicator.classList.add('hidden');
      }, 3000);
    } else {
      this.indicator.classList.remove('hidden');
    }
  }
  
  connect() {
    if (this.socket) {
      console.log('Socket already exists');
      return;
    }
    
    console.log('üîå Connecting to Socket.IO server...');
    this.updateConnectionStatus('connecting');
    
    this.socket = io(window.location.origin, {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000
    });
    
    this.socket.on('connect', () => {
      console.log('‚úÖ Socket.IO connected:', this.socket.id);
      this.isConnected = true;
      this.reconnectAttempts = 0;
      this.updateConnectionStatus('connected');
      showNotification('Live-Updates aktiviert! üéâ', 'success', { duration: 2000 });
    });
    
    this.socket.on('disconnect', (reason) => {
      console.log('‚ùå Socket.IO disconnected:', reason);
      this.isConnected = false;
      this.updateConnectionStatus('disconnected');
    });
    
    this.socket.on('connect_error', (error) => {
      console.error('Socket.IO connection error:', error);
      this.reconnectAttempts++;
      
      if (this.reconnectAttempts >= 5) {
        showNotification(
          'Verbindung zum Server fehlgeschlagen. Bitte Seite neu laden.',
          'error',
          { duration: 0 }
        );
      }
    });
    
    this.registerEventHandlers();
  }
  
  registerEventHandlers() {
    // Loyalty Updates
    this.socket.on('loyalty:update', (data) => {
      console.log('[Socket] loyalty:update', data);
      handleLoyaltyUpdate(data);
    });
    
    // Sales Updates - NEU
    this.socket.on('sales:update', (data) => {
      console.log('[Socket] sales:update', data);
      handleSalesUpdate(data);
    });
    
    // Products Updates - NEU
    this.socket.on('products:update', (data) => {
      console.log('[Socket] products:update', data);
      handleProductsUpdate(data);
    });
    
    // Rush Hour Updates
    this.socket.on('rush-hour:update', (data) => {
      console.log('[Socket] rush-hour:update', data);
      updateRushHourChart(data);
    });
    
    // Stats Deleted - NEU
    this.socket.on('stats:deleted', (data) => {
      console.log('[Socket] stats:deleted', data);
      handleStatsDeleted(data);
    });
    
    // Top Products Updates
    this.socket.on('top-products:update', (data) => {
      console.log('[Socket] top-products:update', data);
      updateTopProductsDropdown();
    });
    
    // Config Updates
    this.socket.on('config:update', (data) => {
      console.log('[Socket] config:update', data);
    });
  }
  
  disconnect() {
    if (this.socket) {
      console.log('üîå Disconnecting Socket.IO');
      this.socket.disconnect();
      this.socket = null;
      this.isConnected = false;
      this.updateConnectionStatus('disconnected');
    }
  }
  
  getConnectionInfo() {
    return {
      connected: this.isConnected,
      socketId: this.socket ? this.socket.id : null,
      reconnectAttempts: this.reconnectAttempts
    };
  }
}

window.liveUpdates = new LiveUpdatesManager();

// === NEUE HANDLER FUNCTIONS ===

function handleSalesUpdate(sales) {
  console.log('Updating sales data...', sales);
  
  // Lokale Daten aktualisieren
  saveSales(sales);
  
  // Charts neu rendern wenn Stats Modal ge√∂ffnet ist
  const modal = document.getElementById('statsModal');
  if (modal && modal.style.display === 'flex') {
    buildStatsChart();
    
    // Animiere Chart Update
    const chartCanvas = document.getElementById('statsChart');
    if (chartCanvas) {
      chartCanvas.classList.add('chart-updating');
      setTimeout(() => chartCanvas.classList.remove('chart-updating'), 500);
    }
    
    // Aktualisiere statsList
    document.getElementById('statsList').innerText = listSalesForUI().join('\n');
    const topProducts = getTopProducts();
    document.getElementById('statsList').innerText += "\n\nüèÜ Top 3 Produkte:\n" + topProducts;
  }
  
  // Zeige Notification f√ºr neuen Verkauf
  const latestDay = Object.keys(sales).sort().pop();
  if (latestDay && sales[latestDay].entries.length > 0) {
    const latestEntry = sales[latestDay].entries[sales[latestDay].entries.length - 1];
    const now = Date.now();
    
    // Nur wenn Verkauf vor weniger als 5 Sekunden war
    if (now - latestEntry.ts < 5000) {
      showNotification(
        `Neuer Verkauf: ${latestEntry.betrag}$ üí∞`,
        'success',
        { duration: 3000 }
      );
    }
  }
}

function handleProductsUpdate(products) {
  console.log('Updating products data...', products);
  
  // Berechne Stats aus products Objekt
  const stats = {};
  for (const [name, data] of Object.entries(products)) {
    if (data.revenue) {
      stats[name] = data.revenue;
    }
  }
  
  // Lokale Daten aktualisieren
  saveProductStats(stats);
  
  // Chart neu rendern wenn Stats Modal ge√∂ffnet ist
  const modal = document.getElementById('statsModal');
  if (modal && modal.style.display === 'flex') {
    buildProductStatsChart();
    updateTopProductsDropdown();
    
    // Animiere Chart Update
    const chartCanvas = document.getElementById('productStatsChart');
    if (chartCanvas) {
      chartCanvas.classList.add('chart-updating');
      setTimeout(() => chartCanvas.classList.remove('chart-updating'), 500);
    }
  }
}

function handleStatsDeleted(data) {
  console.log('Stats deleted:', data);
  
  // Zeige Notification
  showNotification(
    `Statistiken gel√∂scht: ${data.scope} (${data.affectedRecords} Eintr√§ge)`,
    'warning',
    { duration: 5000 }
  );
  
  // L√∂sche entsprechende lokale Daten
  if (data.scope === 'all') {
    localStorage.removeItem(SALES_KEY);
    localStorage.removeItem('lutalo.productStats');
  } else if (data.scope === 'products') {
    localStorage.removeItem('lutalo.productStats');
  } else if (data.scope === 'today') {
    const sales = loadSales();
    const today = todayKey();
    delete sales[today];
    saveSales(sales);
  }
  
  // Charts neu rendern wenn Modal ge√∂ffnet ist
  const modal = document.getElementById('statsModal');
  if (modal && modal.style.display === 'flex') {
    buildStatsChart();
    buildProductStatsChart();
    updateTopProductsDropdown();
    
    // Animiere beide Charts
    ['statsChart', 'productStatsChart'].forEach(id => {
      const canvas = document.getElementById(id);
      if (canvas) {
        canvas.classList.add('chart-updating');
        setTimeout(() => canvas.classList.remove('chart-updating'), 500);
      }
    });
  }
  
  // Rush Hour Chart aktualisieren wenn ge√∂ffnet
  const rushHourDropdown = document.getElementById('rushHourDropdown');
  if (rushHourDropdown && rushHourDropdown.classList.contains('show')) {
    buildRushHourChart();
  }
}

function updateRushHourChart(data) {
  if (!window._rushHourChart) return;
  
  const labels = data.hourlyData.map((_, i) => 
    i.toString().padStart(2,'0') + ':00'
  );
  
  const topValues = data.topHours.map(h => data.hourlyData[h.hour]);
  const bgColors = data.hourlyData.map(v => 
    topValues.includes(v) ? 'rgba(255,99,132,0.8)' : 'rgba(75,0,130,0.5)'
  );
  
  window._rushHourChart.data.labels = labels;
  window._rushHourChart.data.datasets[0].data = data.hourlyData;
  window._rushHourChart.data.datasets[0].backgroundColor = bgColors;
  window._rushHourChart.update('active');
  
  // Animiere Chart Update
  const canvas = document.getElementById('rushHourDropdownChart');
  if (canvas) {
    canvas.classList.add('chart-updating');
    setTimeout(() => canvas.classList.remove('chart-updating'), 500);
  }
  
  if (data.currentHourRevenue > 0) {
    console.log(`üí∞ Aktuelle Stunde: ${data.currentHourRevenue.toFixed(2)}$`);
  }
}

function handleLoyaltyUpdate(data) {
  updateLoyaltyPointsListLive(data);
  
  if (data.action === 'add' && data.customer && data.customer.pointsChange > 0) {
    showLoyaltyPointsAnimation(data.customer);
    
    if (data.levelUp || isLevelUp(data.customer)) {
      showLevelUpCelebration(data.customer);
    }
  }
}

function updateLoyaltyPointsListLive(data) {
  const listEl = document.getElementById("punkteListe");
  if (!listEl) return;
  
  const customers = data.allCustomers || [];
  
  if (customers.length === 0) {
    listEl.innerHTML = "Noch keine Punkte vergeben.";
    return;
  }
  
  const sortedCustomers = [...customers].sort((a, b) => b.points - a.points);
  
  const stats = data.statistics || {
    totalCustomers: customers.length,
    totalPointsGiven: customers.reduce((sum, c) => sum + c.points, 0),
    averagePoints: customers.reduce((sum, c) => sum + c.points, 0) / customers.length
  };
  
  listEl.innerHTML = `
    <div class="loyalty-statistics mb-4 p-3 bg-black/5 dark:bg-white/10 rounded-lg">
      <div class="grid grid-cols-3 gap-2 text-sm">
        <div>
          <div class="opacity-70">Kunden</div>
          <div class="font-bold text-lg">${stats.totalCustomers}</div>
        </div>
        <div>
          <div class="opacity-70">√ò Punkte</div>
          <div class="font-bold text-lg">${stats.averagePoints.toFixed(1)}</div>
        </div>
        <div>
          <div class="opacity-70">Gesamt</div>
          <div class="font-bold text-lg">${stats.totalPointsGiven}</div>
        </div>
      </div>
    </div>
    
    <table class="w-full text-left text-sm">
      <thead>
        <tr class="border-b border-black/10 dark:border-white/10">
          <th class="py-2 font-semibold">Kunde</th>
          <th class="py-2 font-semibold">Punkte</th>
          <th class="py-2 font-semibold">Level</th>
          <th class="py-2"></th>
        </tr>
      </thead>
      <tbody>
        ${sortedCustomers.map((customer, index) => {
          const level = calculateLevelForPoints(customer.points);
          return `
            <tr class="border-t border-black/10 dark:border-white/10 hover:bg-black/5 
                       dark:hover:bg-white/10 transition fade-in ${index < 3 ? 'top-customer' : ''}"
                data-customer="${customer.name}"
                style="animation-delay: ${index * 0.05}s">
              <td class="py-2 font-medium">
                ${index < 3 ? `<span class="rank-badge ${index === 0 ? 'rank-top' : ''}">${index + 1}</span>` : ''}
                ${customer.name}
              </td>
              <td class="py-2">
                <span class="points-badge ${getLevelClass(level)}">
                  ${customer.points} <span class="opacity-70">Pkt</span>
                </span>
              </td>
              <td class="py-2">
                <span class="level-badge ${getLevelClass(level)}">
                  ${getLevelIcon(level)} ${level}
                </span>
              </td>
              <td class="py-2 text-right">
                <button onclick="removePunkte('${customer.name}')" 
                        class="text-xs text-red-500 hover:text-red-700 font-semibold transition">
                  L√∂schen
                </button>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
  
  previousCustomers = sortedCustomers.map(c => ({ name: c.name, points: c.points }));
}

function isLevelUp(customer) {
  if (!customer.pointsChange) return false;
  
  const previousPoints = customer.points - customer.pointsChange;
  const previousLevel = calculateLevelForPoints(previousPoints);
  const currentLevel = customer.level || calculateLevelForPoints(customer.points);
  
  return previousLevel !== currentLevel;
}

// === INITIALISIERUNG ===

document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ Initializing Application...');
  
  initDarkToggle();
  populateThemeSelect();
  loadTheme();
  loadPreise();

  initializeCalculatorStates();
  const savedTab = localStorage.getItem('activeTab');
  if (savedTab) activeTab = parseInt(savedTab);
  const initialBtn = document.querySelector(`.tab-button[data-tab="${activeTab}"]`) || document.querySelector('.tab-button[data-tab="1"]');
  if (initialBtn) {
    initialBtn.classList.add('active');
    updateSliderPosition(initialBtn);
  }
  loadCalculatorStateForTab();

  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => switchTab(parseInt(btn.dataset.tab)));
  });
  
  renderPunkteListe();
  
  // Socket.IO Live Updates starten
  liveUpdates.connect();
  
  // Cleanup beim Verlassen
  window.addEventListener('beforeunload', () => {
    liveUpdates.disconnect();
  });
  
  console.log('‚úÖ Application initialized');
});

window.addEventListener('resize', () => {
  const btn = document.querySelector(`.tab-button[data-tab="${activeTab}"]`);
  if (btn) updateSliderPosition(btn);
});

// Globale Funktionen verf√ºgbar machen
window.toggleDropdown = toggleDropdown;
window.changeQuantity = changeQuantity;
window.copyText = copyText;
window.copyPriceText = copyPriceText;
window.resetRechner = resetRechner;
window.undoLast = undoLast;
window.applyLutaloRabatt = applyLutaloRabatt;
window.berechne = berechne;
window.openStats = openStats;
window.closeStats = closeStats;
window.resetStats = resetStats;
window.closeChangelog = closeChangelog;
window.closeWelcome = closeWelcome;
window.toggleRushHourDropdown = toggleRushHourDropdown;
window.toggleTopProductsDropdown = toggleTopProductsDropdown;
window.resetProductStats = resetProductStats;

</script>

</body>
</html>